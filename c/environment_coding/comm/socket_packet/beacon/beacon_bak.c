#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

#include <sys/socket.h>
#include <netpacket/packet.h>
#include <net/ethernet.h>

#include <netdb.h>
#include <net/if.h>
#include <errno.h>

#define TEST_BEACON \
"\x80\x00\x00\x00\xff\xff\xff\xff\xff\xff\xaa\xbb\xcc\xdd\xee\xff" \
"\xaa\xbb\xcc\xdd\xee\xff\xd0\xb6" \
"\x5a\x91\xa8\xd8\x76\x00\x00\x00\x64\x00\x21\x04\x00\x0b" \
"\x6c\x6f\x6e\x67\x62\x34\x20\x77\x69\x66\x69" \
"\x01\x08\x82\x84\x8b\x96\x24" \
"\xb0\x48\x6c\x03\x01\x01\x05\x04\x00\x01\x00\x00\x2a\x01\x00\x2f" \
"\x01\x00\x32\x04\x8c\x12\x98\x60\x2d\x1a\xbd\x18\x1b\xff\xff\xff" \
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
"\x00\x00\x00\x00\x3d\x16\x01\x08\x15\x00\x00\x00\x00\x00\x00\x00" \
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xdd\x09\x00\x10" \
"\x18\x02\x00\x00\x1c\x00\x00\xdd\x18\x00\x50\xf2\x02\x01\x01\x84" \
"\x00\x03\xa4\x00\x00\x27\xa4\x00\x00\x42\x43\x5e\x00\x62\x32\x2f" \
"\x00"

int main(void){
    uint16_t proto = htons(ETH_P_ALL);
    int packet_socket = socket(AF_PACKET, SOCK_RAW, proto);
	unsigned char buf[]={0x00, 0x00, 0x1a, 0x00, 0x2f, 0x48, 0x00, 0x00, 0x7e, 0x93, 0x85, 0x3b, 0x67, 0x06, 0x00, 0x00,
0x02, 0x18, 0x6c, 0x09, 0xc0, 0x00, 0xb3, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0x08, 0x10, 0x78, 0xc8, 0xc9, 0x50, 0x08, 0x10, 0x78, 0xc8, 0xc9, 0x50,
0x00, 0x01, 0x7e, 0x79, 0x9d, 0xd9, 0x0b, 0x00, 0x00, 0x00, 0x19, 0x00, 0x11, 0x04, 0x00, 0x0b,
0x7a, 0x68, 0x61, 0x6e, 0x67, 0x79, 0x75, 0x79, 0x61, 0x6e, 0x67, 0x01, 0x08, 0x82, 0x84, 0x8b,
0x96, 0x0c, 0x12, 0x18, 0x24, 0x03, 0x01, 0x01, 0x05, 0x04, 0x02, 0x03, 0x00, 0x00, 0x2a, 0x01,
0x04, 0x32, 0x04, 0x30, 0x48, 0x60, 0x6c, 0x2d, 0x1a, 0xee, 0x19, 0x1f, 0xff, 0xff, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x3d, 0x16, 0x01, 0x05, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xdd, 0x1a, 0x00, 0x50, 0xf2,
0x01, 0x01, 0x00, 0x00, 0x50, 0xf2, 0x02, 0x02, 0x00, 0x00, 0x50, 0xf2, 0x02, 0x00, 0x50, 0xf2,
0x04, 0x01, 0x00, 0x00, 0x50, 0xf2, 0x02, 0x30, 0x18, 0x01, 0x00, 0x00, 0x0f, 0xac, 0x02, 0x02,
0x00, 0x00, 0x0f, 0xac, 0x02, 0x00, 0x0f, 0xac, 0x04, 0x01, 0x00, 0x00, 0x0f, 0xac, 0x02, 0x00,
0x00, 0xdd, 0x18, 0x00, 0x50, 0xf2, 0x02, 0x01, 0x01, 0x00, 0x00, 0x03, 0xa4, 0x00, 0x00, 0x27,
0xa4, 0x00, 0x00, 0x42, 0x43, 0x5e, 0x00, 0x62, 0x32, 0x2f, 0x00, 0xdd, 0x1e, 0x00, 0x90, 0x4c,
0x33, 0xee, 0x19, 0x1f, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xdd, 0x1a, 0x00, 0x90, 0x4c,
0x34, 0x01, 0x05, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xdd, 0x06, 0x00, 0xe0, 0x4c, 0x02, 0x01, 0x60};
    printf("packet_socket == %d\n", packet_socket);
	//printf("%d\n",sizeof(buf));
	if(packet_socket<0){
		perror("socket error\n");
		return -1;
	}

    struct sockaddr_ll sa_ll;
    memset(&sa_ll, 0, sizeof(sa_ll));
    char *iface = "mon0";
    int iface_num = if_nametoindex(iface);
    sa_ll.sll_family = AF_PACKET;
    sa_ll.sll_protocol = proto;
    sa_ll.sll_ifindex = iface_num;
    //sa_ll.sll_pkttype = PACKET_OUTGOING;
    //sa_ll.sll_halen = ETHER_ADDR_LEN;

    /*int bind_rv = bind(packet_socket, (struct sockaddr *) &sa_ll, sizeof(sa_ll));
    if (bind_rv >= 0) {
        printf("bind_rv == %d\n", bind_rv);
    } else {
        perror("bind");
    }*/

    //侦听数据
    int i; 
    char bbuf[1024];
    int size;
    /*for(i=0;i<100;i++)
    {
        size=recvfrom(packet_socket,bbuf,1024,0,NULL,NULL);
        if(size>0){
            printf("data comes:%d\n",size);
            if(i==1){
                write(1,bbuf,size);
                printf("\n");
            }
        }
        else if(size<0){
            perror("recvfrom error\n");
            close(packet_socket);
            return -1;
        }
    }*/

	int buf_len = sizeof(buf);

	for(i=0;i<100;i++){
		sleep(1);
		int sendto_rv = sendto(packet_socket, buf, buf_len, 0, (struct sockaddr *) &sa_ll, sizeof(sa_ll));
		if (sendto_rv >= 0) {
		    printf("Sent msg\n");
		} else {
		    perror("sendto");
		}
	}
    close(packet_socket);
    return 0;
}
